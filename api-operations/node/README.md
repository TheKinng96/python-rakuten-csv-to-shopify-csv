# Shopify GraphQL Manager

Node.js GraphQL operations for Shopify product management, designed to work with JSON data generated by Python analysis scripts.

## Overview

This Node.js application processes JSON data from Python analysis scripts and performs bulk operations on Shopify products using GraphQL mutations. It's designed for efficient, rate-limited processing of large product catalogs.

## Architecture

- **Python Scripts**: Analyze CSV data and generate JSON files in `shared/` directory
- **Node.js Scripts**: Process JSON files and execute GraphQL operations on Shopify
- **Shared Configuration**: Uses same `.env` file as Python scripts for consistency

## Setup

### Prerequisites
- Node.js 18+ 
- Access to Shopify Admin API with appropriate permissions
- Python analysis scripts have been run and generated JSON files

### Installation

```bash
cd node
npm install
```

### Configuration

Uses the shared `.env` file from the parent directory:

```bash
# Required for all operations
SHOPIFY_TEST_STORE_URL=your-test-store.myshopify.com
SHOPIFY_TEST_ACCESS_TOKEN=your-test-access-token

# Optional: Production store (use with extreme caution)
SHOPIFY_PROD_STORE_URL=your-prod-store.myshopify.com
SHOPIFY_PROD_ACCESS_TOKEN=your-prod-access-token

# Processing settings
DRY_RUN=true                    # Set to false for actual operations
MAX_REQUESTS_PER_SECOND=40
BATCH_SIZE=250
```

### Test Connection

```bash
npm run test
```

## Available Operations

### 1. Import Products to Test Store

Imports products from Python-generated JSON to Shopify.

```bash
# Generate JSON first (Python)
cd .. && uv run scripts/00_import_to_test.py

# Import to Shopify (Node.js)
cd node && npm run import
```

**Input**: `shared/products_for_import.json`  
**Output**: `reports/00_import_results.json`

### 2. Remove SS Images

Removes `-XXss.jpg` images identified by Python analysis.

```bash
# Generate analysis first (Python)
cd .. && uv run scripts/01_analyze_ss_images.py

# Remove SS images (Node.js)
cd node && npm run remove-ss
```

**Input**: `shared/ss_images_to_remove.json`  
**Output**: `reports/01_ss_removal_results.json`

### 3. Fix HTML Tables

Fixes HTML table structure issues identified by Python analysis.

```bash
# Generate analysis first (Python)
cd .. && uv run scripts/02_analyze_html_tables.py

# Fix HTML tables (Node.js)
cd node && npm run fix-tables
```

**Input**: `shared/html_tables_to_fix.json`  
**Output**: `reports/02_table_fix_results.json`

### 4. Clean Rakuten Content

Removes EC-UP patterns and Rakuten-specific content.

```bash
# Generate analysis first (Python)
cd .. && uv run scripts/03_analyze_rakuten.py

# Clean Rakuten content (Node.js)
cd node && npm run clean-rakuten
```

**Input**: `shared/rakuten_content_to_clean.json`  
**Output**: `reports/03_rakuten_clean_results.json`

### 5. Insert Correct Images

Adds images to products based on CSV input (for missing images).

```bash
# Generate missing images list first (Python)
cd .. && uv run scripts/04_audit_images.py

# Create CSV with correct images (Manual step)
# Create reports/images_to_insert.csv with format:
# product_handle,image_url,alt_text,position

# Insert images (Node.js)
cd node && npm run insert-images
```

**Input**: `reports/images_to_insert.csv`  
**Output**: `reports/04_image_insert_results.json`

## Safety Features

- **Test Store First**: All operations default to test store
- **Dry Run Mode**: Preview operations without making changes (DRY_RUN=true)
- **Rate Limiting**: Respects Shopify API limits (configurable RPS)
- **Batch Processing**: Memory-efficient processing of large datasets
- **Comprehensive Logging**: Detailed JSON reports for audit and rollback
- **Error Recovery**: Robust retry logic for network issues

## File Structure

```
node/
├── src/
│   ├── 00_import_products.js     # Import products from JSON
│   ├── 01_remove_ss_images.js    # Remove SS images
│   ├── 02_fix_html_tables.js     # Fix HTML table issues
│   ├── 03_clean_rakuten.js       # Clean Rakuten content
│   ├── 04_insert_images.js       # Insert images from CSV
│   ├── config.js                 # Configuration management
│   ├── shopify-client.js         # GraphQL client with rate limiting
│   └── test_connection.js        # Connection testing
├── package.json                  # Dependencies and scripts
└── README.md                     # This file
```

## Workflow

1. **Python Analysis**: Generate JSON data files
2. **Node.js Processing**: Execute GraphQL operations
3. **Verification**: Check results in Shopify admin
4. **Iteration**: Repeat for remaining issues